<!DOCTYPE html>
<html lang="en">
<head>
  <title> Live Timing Dashboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/particle-api-js/5/particle.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="node_modules/epoch-charting/dist/js/epoch.min.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdDECh5tFSeaM9QoBxasV9jKglg_cewIo&callback=init">
  </script>
  

  <link rel="stylesheet" type="text/css" href="node_modules/epoch-charting/dist/css/epoch.min.css">

  <style>    
  footer {
    background-color: #555;
    color: white;
    padding: 15px;
  }


  .circle {
    width: 30px;
    height: 30px;
    background: #56BF56;
    -moz-border-radius: 50px;
    -webkit-border-radius: 50px;
    border-radius: 50px;
  }

  .borderless-panel {
    border-width: 0;
    border-bottom-width: 0;
  }

  .well-white {
    background-color: white;
  }

  .btn-higher {
    top: 0;
  }
}

</style>
</head>
<body onload = "init()">

  <div class="container text-center">
    <!-- <div class="col-sm-12">  -->   
    <div class="row">
     <!-- <div class="col-sm-12"> -->
     <div class="panel panel-default text-left borderless-panel">
       <div class="panel-body">
        <div class = "col-sm-6">
         <h1 style = "color: #4A4A4A"> <strong> Resistance Racing: Dashboard </strong> </h1>
       </div>
       <div class = "col-sm-3">
         <img src = "RRLogoMain.png" alt = "Resistance Racing Logo" width = "300" height = "100" align = "left">
       </div>
     </div>
   </div>
   <!-- </div> -->
 </div>
 <!-- </div> -->
</div>


<div class="container text-left"> 
 <div class="row">
   <!-- <div class="panel panel-default text-left borderless-panel"> -->
   <!-- <div class="panel-body"> -->
   <div class = "col-sm-1">
     <p style = "font-weight:bold; font-size:130%; color: #4A4A4A" id = "lapNumber"> Lap # 0 </p>
   </div>
   <!-- <div class = "col-sm-5"> -->
   <button onClick = "updateLap()" type="button" class="btn btn-danger btn-higher">Next Lap</button>
   <div> <br> </div>
   <!-- </div> -->
   <!-- </div> -->
   <!--  </div> -->

 </div>
</div>


<div class="container text-center">    
  <div class="row">


    <div class="col-sm-3 well well-white">
      <p> <strong> Faults </strong> </p>
      <div class="well well-white">
       <div class="row">
        <div class="col-sm-2">
          <div class="circle" id = "BMSFault"></div>
        </div>
        <div class="col-sm-8">
          <p>BMS</p>
        </div>
      </div>

      <br>

      <div class="row">
        <div class="col-sm-2">
          <div class="circle" id = "MCFault"></div>
        </div>
        <div class="col-sm-8">
          <p>Motor Controller</p>
        </div>
      </div>


    </div>

    <div class="well"> </div>

    <div class="alert alert-success fade in">
      <a href="#" class="close" data-dismiss="alert" aria-label="close">Ã—</a>
      <p><strong> Highlight!</strong></p>

    </div>

  </div>


  <div class="col-sm-7">

    <div class="row">
      <div class="col-sm-12">
        <div class="panel panel-default text-left">
          <div class="panel-body">
            <p> Stats (Prelim Display) </p>
            <p> <strong> Throttle</strong> </p>
            <p id = "throttleStats">  </p>
            <p> <strong> Speed</strong> </p>
            <p id = "speedStats">  </p>
            <p> <strong> Last Updated</strong> </p>
            <p id = "lastUpdatedStats">  </p>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-6">
        <div class="well">
         <p style = "font-weight:bold">Current</p>
         <p> Double click on the map to add a note. </p>
         <div id="map_canvas_current" style="height:300px"></div>
         <!-- <img src="bird.jpg" class="img-circle" height="55" width="55" alt="Avatar"> -->
       </div>
     </div>
     <div class="col-sm-6">
      <div class="well">
        <p style = "font-weight:bold">Previous</p>
        <p> Description </p>
        <div id="map_canvas_prev" style="height:300px"></div>
      </div>
    </div>
  </div>


</div>


<div class="col-sm-2 well">     
  <div class="well">
    <p>Additional</p>
  </div>
  <div class="well">
    <p>Additional</p>
  </div>
</div>
</div>

<div class="row">
  <div class="col-sm-12">
    <h3>Speed</h3>
    <div id="speedChart" class="epoch" style="height: 200px;"></div>
    <h3>Throttle</h3>
    <div id="throttleChart" class="epoch" style="height: 200px;"></div>
  </div>
</div>
</div>

<footer class="container-fluid text-center">
  <p>Footer Text</p>
</footer>

<script>

// Race Information 
var lap = 0;
var latestGPSTimeStamp;
var latestGPSCoordinates;

function changeLastUpdatedStats(num) {
  $('#lastUpdatedStats')[0].innerHTML = "" + num;
}

function changeThrottleStats(num, lastUpdated) {
  $('#throttleStats')[0].innerHTML = "" + num;
  changeLastUpdatedStats(lastUpdated);
}

function changeSpeedStats(num, lastUpdated) {
  $('#speedStats')[0].innerHTML = "" + num;
  changeLastUpdatedStats(lastUpdated);
}

function faultBMS(bool) {
  if (bool) {
    $('#BMSFault')[0].style.background = "#E53838";
  } else {
    $('#BMSFault')[0].style.background = "#56BF56";
  }
}

function faultMC(bool) {
  if (bool) {
    $('#MCFault')[0].style.background = "#E53838";
  } else {
    $('#MCFault')[0].style.background = "#56BF56";
  }
}

function updateLap() {
  if (lap == 8) {
    // TODO: send data back to Electron
  } else {
    lap ++;
    $('#lapNumber')[0].innerHTML = "Lap # " + lap;
  }
}

</script>

<script>
var particle = new Particle();
var token;
// Login
particle.login({username: 'cornellresistance@gmail.com', password: 'clifford'}).then(
  function(data) {
    console.log('LOGGED IN.');
    token = data.body.access_token;
    console.log(token);
    getEventStream();
  },
  function (err) {
    console.log('Could not log in.', err);
  }
  );

// Get event stream
function getEventStream() {
  //Successful login: get devices events
  console.log('Begin event stream.');
  particle.getEventStream({ deviceId: 'mine', auth: token }).then(function(stream) {
    stream.on('event', function(json) {
      console.log(JSON.stringify(json, null, 4));
      parseData (json.data);
    });
  });
}

// Parse live data
function parseData (data) {
  // Parse live data 
  var dataArr = data.split("_");

  for (var i in dataArr) {

    var dataI = dataArr[i];
    var dataIArr = dataI.split(";");
    var property = dataIArr[0];
    var value = dataIArr[1];
    var time = dataIArr[2];

    switch (property) {
      case "throttle": 
      changeThrottleStats(value, time);
      throttleChartInstance.push([{time: time/1000.0, y: value}]);
      break;
      case "speed": 
      changeSpeedStats(value, time);
      speedChartInstance.push([{time: time/1000.0, y: value}]);
      break;
      case "fault":
      parseFaultData(value);
      break;
      case "gps":
      latestGPSTimeStamp = time;
      updateMap(value);
      default:
      break;
    }
  }
}

function parseFaultData(value) {
  switch (value) {
    case "0":
    faultBMS(false);
    faultMC(false);
    break;
    case "1":
    faultBMS(false);
    faultMC(true);
    break;
    case "2":
    faultBMS(true);
    faultMC(false);
    break;
    case "3":
    faultBMS(true);
    faultMC(true);
    break;
    default:
    break;
  }
}



</script>
<script>
// Input form div, for google maps note taking later on
var controlDiv = document.createElement('DIV');
controlDiv.id = "controls";

var controlInput = document.createElement('input');
controlInput.id = "note";
controlInput.name = "note";
// controlInput.value = "Hi there!";

var controlLabel = document.createElement('label');
controlLabel.innerHTML = 'Note';
controlLabel.setAttribute("for","note");

var controlButton = document.createElement('button');
controlButton.innerHTML = 'Create note!';
controlButton.innerHTML = 'Send it!';

controlButton.addEventListener ("click", function() {
  if (latestNoteMarker != undefined) {
    latestNoteMarker.title = $("#note").val();
    controlInput.value = "";
  }
})


controlDiv.appendChild(controlLabel);
controlDiv.appendChild(controlInput);
controlDiv.appendChild(controlButton);

</script>
<script>
/* Maps Init JS */
var blueDot = 'http://www.robotwoods.com/dev/misc/bluecircle.png';
var noteMarker = 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png';
var curPos;
var mapCur;
var mapPrev;
var polyCur;
var change = 0;
var colorCur = 'green';
var prevLatLng;
var drawMap;
var latestNoteMarker;

function init() {
  var initLatLng = new google.maps.LatLng({lat: 38.16121, lng: -122.45422});
  
  var mapOptions = {
    zoom: 17,
    center: initLatLng,
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    disableDoubleClickZoom: true
  };

  mapCur = new google.maps.Map(document.getElementById('map_canvas_current'),
    mapOptions);

  curPos = new google.maps.Marker({
    position: initLatLng,
    map: mapCur,
    icon: blueDot
  });

  mapPrev = new google.maps.Map(document.getElementById('map_canvas_prev'),
    mapOptions);

  polyCur = new google.maps.Polyline({
    strokeColor: colorCur,
    strokeOpacity: 1,
    strokeWeight: 3,
    map: mapCur
  });

   // ROUTE DRAWING (for presentation purposes)
  drawMap = function(latLng) {
    if (change % 5 == 0 && change != 0) {
      var color = (colorCur == 'green') ? 'red' : 'green';
      var poly = new google.maps.Polyline({
        strokeColor: color,
        strokeOpacity: 1,
        strokeWeight: 3,
        map: mapCur
      });

      polyCur = poly;
      change++;
      colorCur = color;

      var path = poly.getPath();
      path.push(prevLatLng);
      path.push(latLng);
    } else {
      path = polyCur.getPath();
      path.push(latLng);
      change++;
      prevLatLng = latLng;
    }
  }

  // NOTE MARKING (for presentation purposes)
  mapCur.addListener('dblclick', function(e) {

    var marker = new google.maps.Marker({
      position: e.latLng,
      map: mapCur,
      icon: noteMarker,
      title: "Note1",
    });
    latestNoteMarker = marker;
  });

  mapCur.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlDiv);
  


}

function fail(){
  alert('navigator.geolocation failed, may not be supported');
}

function updateMap(value) {
  var latLng_arr = value.split(",");
  var latLng = new google.maps.LatLng(parseFloat(latLng_arr[0]), parseFloat(latLng_arr[1]));
  mapCur.setCenter(latLng);
  mapPrev.setCenter(latLng);
  curPos.setPosition(latLng);
  drawMap(latLng);
}



</script>

<script>

function addDataToPoly(ideal, real, latLng, poly) {
  var color = (real < ideal) ? 'red' : 'green';
  poly.setOptions({strokeColor: color});
  var path = poly.getPath();
  path.push(latLng);
}

</script>
<script>
/* Charting JS */
var speedData = [
{ label: 'Speed', values: [] }
];
var throttleData = [
{ label: 'Throttle', values: [] }
];
var speedChartInstance = $('#speedChart').epoch({
  type: 'time.line',
  data: speedData,
  axes: ['left', 'right', 'bottom']
});
var throttleChartInstance = $('#throttleChart').epoch({
  type: 'time.line',
  data: throttleData,
  axes: ['left', 'right', 'bottom']
});
</script>

</body>
</html>
